=  DevOps at Sonatype
:title: Lessons Learned using Repository Managers and Supply Chain Tools for DevOps at Sonatype
:Author:   Manfred Moser, Sonatype, Inc.
:Date: October 2015
:icons:
:copyright: Copyright 2011-present, Sonatype Inc. All Rights Reserved.
:incremental:

== DevOps at Sonatype
:incremental!:

[quote]
Lessons Learned from Using Repository Managers and Software Supply Chain Tools 

Manfred Moser - http://twitter.com/simpligility[@simpligility] 

* Community Advocate, Author & Trainer

Brian Fox - http://twitter.com/brian_fox[@brian_fox] 

* VP of Product Management

Sonatype - http://twitter.com/sonatypebrian_fox[@sonatype] - http://www.sonatype.com[www.sonatype.com]

== What Are You Learning Today?
:incremental!:

[quote]
What worked? What caused problems?

-> Apply 'our' lessons to 'your' situation

== What does Sonatype actually do? 
:incremental!:

Manages and develops:

* Central Repository (aka Maven Central)
* OSSRH and related Forges
* Nexus Repository Manager
* Nexus IQ Server
* Nexus IQ Data Services
* Related documentation, websites, blogs, videos,...

== Software Component Warehouse
:incremental!:

Nexus Repository Manager

* 70% market share
* > 61K active server installations
* Open Source: Maven2, npm, RubyGems, NuGet, Docker, ...
* Commercial: Component Information, Staging, Smart Proxy, User Token, ...
* Nexus 3 - distinct new codebase

== Software Supply Chain Solutions
:incremental!:

Solutions:

* Nexus Firewall
* Nexus Auditor
* Nexus Lifecycle
* Nexus Suite

Include

* Nexus IQ Server
* Integrations with Jenkins, Hudson, Bamboo
* Eclipse IDE/M2e Plugin
* SonarQube integration
* Command-line tool and REST API

All of this is backed by... 

== Nexus IQ Data Services
:incremental!:

Managed and *curated* data and services for:

* Age
* Popularity
* Security vulnerability data
* License analysis data (observed and declared)
* Multiple component formats

== Central Repository 
:incremental!:

[quote]
aka. Maven Central

* Largest Maven2 format repository
* High performance, global CDN 
* > 17 billion download in 2014
* > 1 million GAV coordinates
* Default in Apache Maven and others

And the components come from...

== OSSRH and Forges
:incremental!:

Input funnel for Central Repository

* OSSRH - large deployment of Nexus Repository Manager
* Apache, JBoss, ... - secondary Nexus instances
* Community support - onboarding and documentation

== More OSSRH and Central Stats

* currently about 100k projects total
* approx. 3000 new projects each month (GA)
* 10 - 30 project verfied and onbarded per day
* approx. 30.000 new releases each month (GAV)

== Who Helps at Sonatype
:incremental!:

* Internationally distributed 
* Multiple-time zones
* Remote work the rule, not the exception
* Roughly 100 people

TIP: Western North America to Eastern Europe

image::images/nexus-team-timezones.png[scale=100]

== Teams
:incremental!:

* Numerous smaller teams
* Different focus of teams
* Cross-team members 
* Dynamic grouping around efforts - 'task force'

== Process

In a nutshell - nothing special, no surprises.

image::images/usual-process.png[scale=100]

== Process

* Scrum framework
* Kanban inspired
* Backlog refinement
* Regular meetings

-> Differs per team!

[quote]
Everyone has their own process. You need to figure out what works for you!


== Communication
:incremental!:

* Good old phone and VOIP
* Atlassian HipChat
* Google Hangouts
* join.me
* PagerDuty

TIP: Using video more has helped avoid misunderstandings.

== Source Control
:incremental!:

* GitHub - public and private
* Atlassian Stash - private only

TIP: We are an earlier Git adopter and use it exclusively. 

== Track and Plan
:incremental!:

* Atlassian JIRA
* Trello
* Basecamp
* Aha.io
* Salesforce

Tool Lessons:

* Different people use different tools
* Overlap is inevitable
* Be prepared to implment integrations
* Tools come and go - be agile

== Continuous Integration
:incremental!:

* Stopped using Hudson long time ago
* Atlassian Bamboo

== Build
:incremental!:

* Apache Maven
* Grunt and NPM for client side
* Shell scripts

== Maven Tips and Tricks
:incremental!:

* Maven wrapper
* Follow best practices
* Organization POM
* Enforcer Plugin
* and lots more

== (Maven) Project Complexity

Find balance for

* Number vs size of projects
* Multi-module vs multiple projects
* Consider release cycle
* IDE functionality
* Build time

TIP: Example Nexus OSS and Nexus Repository Manager

== Develop
:incremental!:

* Feature branches
** short lived
** sometimes shared between
** automatic Bamboo feature branch build creation
* IDE
** Eclipse IDE
** IntelliJ IDEA
* Lots of OSX, some Windows & Linux

== Test
:incremental!:

Unit, functional and manual

* Junit
* Geb
* Spock
* Pax Exam
* Selenide

TIP: No tests, no merge!

== Document
:incremental!:

Multiple output formats from:

* Atlassian Confluence
* Google Docs
* Asciidoc
* Pelican

Instituting development workflows including 

* Git-based versioning 
* and branching, 
* pull requests and reviews 
* and CI builds 

is very useful! 

== Continuously Build
:incremental!:

* Atlassian Bamboo
* > 100 build plans
* Elastics Bamboo - EC2 instances
* Feature branch builds increases number
* Automated functional test suite runs
* Automated release
* Documentation builds and deployments

== Build Plan Commonalities

All builds plans:

* Common configuration from base plan - used as shared artifact, managed in git repo
* Global variables - defaults that allow overrides
* 'build' task - compile and test code.
* 'release' task - publish to Nexus and tag in git
* bundle test artifacts
* Main vs features branches - different config
* Branch builds auto-created

TIP: Consistency helps users and administrators.

== Bamboo Set Up & Tips
:incremental!:

* Resource base plan project with tool configuration
* Fresh Maven repo for each build off Nexus
* Build plan notifications into HipChat channels
* Links to GitHub and JIRA 

== More Bamboo Set Up & Tips
:incremental!:

* Limited number of standard Amazon Machine Images (AMI)
** Include standard tools
* Share and store repo and other outputs as build artifacts
** Stored on Amazon Elastic Block Storage (EBS)
* Static documentation = usable artifact

== Validate
:incremental!:

* SonarQube - integrated in Bamboo and GitHub
* License check with Maven plugin
* Pull requests and code reviews
** No merges without build passing and code review 
* Component policy with Nexus Lifecycle

== Release
:incremental!:

* Workflow and notification with Nexus staging
* Including validation with Nexus Lifecycle
** Security checks
** License checks
** Architecture checks (e.g. component age)
* Usage of release build number - `2.11.4-01`
* Same release stuff on OSSRH

== Release
:incremental!:

image::images/nexus-bamboo-staging.png[scale=100]


== Software Supply Chain Management
:incremental!:

[quote]
We are dogfooding our own tools 

* Nexus Repository Manager
* Nexus Lifecycle

including Bamboo integration and IDE integration.


== Nexus Repository Manager 

* Component source for consumers
* Component target for producers

image::images/producers-consumers.png[scale=100]

== Colocate For Performance

Continuous integration is consumer and producer.

Best practice: 

* Get it close together
* And sync to another repository if needed. 

image::images/nexus-bamboo-rso.png[scale=100]


== Nexus Lifecycle 

* Visualize risk through rule-based automation
* Streamlines component selection with real time data

== Starting Off

* Define risks we care about (internal, external, customer used)
* Open source contributions change out policy (since we contribute it makes sense to use bleeding edge)
* Understand our process and tooling
* limit overhead in our build automation

== Nexus IQ Server Deployment

image::images/nexus-iq-server-integration.png[scale=100]

== Policy

image::images/sonatype-policy.png[scale=100]


== Resulting Report

image::images/nexus-clm-report.png[scale=100]



= Nexus Repository Manager Lessons
* SNAPSHOT versions of master are deployed to Nexus
* feature branch versions are not deployed
* master = integration branch
* within build cluster
* also used by developers
* target for deployments
* proxy 
* host 
* staging
* Thousands of users and projects on OSSRH
* smart proxy to Nexus outside cluster



== Black and White Listing

Wont work .. tbd

== Golden Repository 

wont work


== Perimeter Protection

is Nexus Firewall. Can help


== Nexus Lifecycle Lessons

* Surprise how many components are used - so many!
* Blocking a release for policy violations
** is a big stick
** but it works


Expect some cleanup of old issues

Socialize the resolution/enforcement process

Low noise and fast results increases usage, adoption

Automate and let the tooling do work (I already have a day job!)

Be responsive (That is my day job!)




== Deploy

Ops team:

* RPMs
* Docker images

== Support

[Quote]
The support team consists of engineers only.

* Write lots of automation and other code
* Atlassian JIRA
* ZenDesk 

== Operations

* SaaS is used whenever possible
* Kanban process
* iDoneThis

TIP: Our Nexus instances vary from hundreds of GB to terabytes of non-proxied context.


== Operations - Service Management

Nexus as component warehouse with Ansible

image::images/service-management.png[scale=100]

== Community
:incremental!:

* Actively work with vendors
* Including open source projects
* Help upstream to help yourself
** Report issues
** Release testing
** Contributions
* Avoid forking third party libraries
* But do it cleanly when necessary

== Next?
:incremental!:

* Join the http://www.sonatype.org/nexus/[Nexus community]
* Star using Nexus OSS
* Try Nexus Repository Manager
* Try Nexus Lifecycle
* Come to our booth

== The End 
:incremental!:

Questions, Remarks &  Discussion

TIP: Slides and examples at http://sonatype.github.io/nexus-presentations/[http://sonatype.github.io/nexus-presentations/] or email manfred@sonatype.com

... and we are hiring!

== Resources
:incremental:

* http://www.sonatype.com[sonatype.com]
* http://www.sonatype.org/nexus/[Nexus community]
* http://search.maven.org[Central Repository] and http://central.sonatype.org[documentation]
* https://www.youtube.com/user/sonatype[Youtube channel]
* http://www.sonatype.org/nexus/2015/04/16/using-atlassian-bamboo-and-nexus-for-continuous-integration/[Inside Engineering - blog post]
* http://www.sonatype.org/nexus/members-only/video-gallery-2/inside-the-sonatype-engineering-machine-the-process-and-the-tooling/[Inside Engineering - videos]
* http://www.sonatype.org/nexus/members-only/video-gallery-2/free-training-sonatype-nexus-and-clm-tips-from-the-trenches/[Nexus Tips from the Trenches video series]
* http://www.sonatype.com/about/2014-open-source-software-development-survey[2014 Open Source Software Development Survey Results]
* http://www.sonatype.com/speedbumps[2015 State of the Software Supply Chain Report]
* http://www.slideshare.net/SonatypeCorp[Sonatype slides]
* http://links.sonatype.com/products/nexus/oss/docs[Repository Management with Nexus]
* http://zeroturnaround.com/rebellabs/java-tools-and-technologies-landscape-for-2014/[Java Tools and Technologies Landscape for 2014]
* http://sonatype.github.io/nexus-presentations/[Nexus related slides including this one...]
